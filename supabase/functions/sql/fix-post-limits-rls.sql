-- ğŸ”§ æŠ•ç¨¿åˆ¶é™æ©Ÿèƒ½ RLSãƒãƒªã‚·ãƒ¼ä¿®æ­£
-- 42501ã‚¨ãƒ©ãƒ¼ï¼ˆRLSé•åï¼‰ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

-- 1. æ—¢å­˜ã®ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤
DROP POLICY IF EXISTS "Users can view own post counts" ON daily_post_counts;
DROP POLICY IF EXISTS "System can manage post counts" ON daily_post_counts;

-- 2. æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆï¼ˆã‚ˆã‚Šå…·ä½“çš„ãªæ¨©é™è¨­å®šï¼‰
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æŠ•ç¨¿æ•°ã®ã¿å‚ç…§å¯èƒ½
CREATE POLICY "Users can view own post counts" ON daily_post_counts
    FOR SELECT USING (auth.uid()::text = user_id);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æŠ•ç¨¿æ•°ã®ã¿æŒ¿å…¥å¯èƒ½
CREATE POLICY "Users can insert own post counts" ON daily_post_counts
    FOR INSERT WITH CHECK (auth.uid()::text = user_id);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æŠ•ç¨¿æ•°ã®ã¿æ›´æ–°å¯èƒ½
CREATE POLICY "Users can update own post counts" ON daily_post_counts
    FOR UPDATE USING (auth.uid()::text = user_id);

-- 3. é–¢æ•°å®Ÿè¡Œã®ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨©é™ã‚’é©ç”¨
-- increment_user_post_counté–¢æ•°ã‚’SECURITY DEFINERã§å†ä½œæˆ
CREATE OR REPLACE FUNCTION increment_user_post_count(p_user_id TEXT, p_post_date DATE DEFAULT CURRENT_DATE)
RETURNS BOOLEAN
SECURITY DEFINER
AS $$
DECLARE
    v_can_post BOOLEAN;
    v_current_user_id TEXT;
BEGIN
    -- ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    v_current_user_id := auth.uid()::text;
    
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼šå‘¼ã³å‡ºã—å…ƒãŒå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜ã‹ç¢ºèª
    IF v_current_user_id IS NULL OR v_current_user_id != p_user_id THEN
        RAISE EXCEPTION 'Unauthorized access: user can only increment their own post count';
    END IF;
    
    -- æŠ•ç¨¿å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    SELECT can_post INTO v_can_post
    FROM check_user_post_limit(p_user_id, p_post_date);
    
    -- æŠ•ç¨¿å¯èƒ½ãªå ´åˆã®ã¿æŠ•ç¨¿æ•°ã‚’å¢—åŠ 
    IF v_can_post THEN
        INSERT INTO daily_post_counts (user_id, post_date, post_count)
        VALUES (p_user_id, p_post_date, 1)
        ON CONFLICT (user_id, post_date)
        DO UPDATE SET 
            post_count = daily_post_counts.post_count + 1,
            updated_at = NOW();
        
        RETURN TRUE;
    END IF;
    
    RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- 4. check_user_post_limité–¢æ•°ã‚‚SECURITY DEFINERã§å†ä½œæˆ
CREATE OR REPLACE FUNCTION check_user_post_limit(p_user_id TEXT, p_post_date DATE DEFAULT CURRENT_DATE)
RETURNS TABLE (
    can_post BOOLEAN,
    current_count INTEGER,
    daily_limit INTEGER,
    remaining_posts INTEGER,
    membership_type TEXT
)
SECURITY DEFINER
AS $$
DECLARE
    v_membership_type TEXT;
    v_daily_limit INTEGER;
    v_current_count INTEGER;
    v_limit_removed_count INTEGER;
    v_current_user_id TEXT;
BEGIN
    -- ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    v_current_user_id := auth.uid()::text;
    
    -- p_user_idãŒnullã§ãªã„ã“ã¨ã‚’ç¢ºèª
    IF p_user_id IS NULL OR p_user_id = '' THEN
        RAISE EXCEPTION 'user_id cannot be null or empty';
    END IF;
    
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼šå‘¼ã³å‡ºã—å…ƒãŒå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜ã‹ç¢ºèª
    IF v_current_user_id IS NULL OR v_current_user_id != p_user_id THEN
        RAISE EXCEPTION 'Unauthorized access: user can only check their own post limit';
    END IF;
    
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šå“¡æƒ…å ±ã‚’å–å¾—
    SELECT um.membership_type, um.daily_post_limit
    INTO v_membership_type, v_daily_limit
    FROM user_memberships um
    WHERE um.user_id = p_user_id;
    
    -- ä¼šå“¡æƒ…å ±ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡æ–™ä¼šå“¡ã¨ã—ã¦ä½œæˆ
    IF v_membership_type IS NULL THEN
        INSERT INTO user_memberships (user_id, membership_type, daily_post_limit)
        VALUES (p_user_id, 'free', 3)
        ON CONFLICT (user_id) DO UPDATE SET 
            membership_type = EXCLUDED.membership_type,
            daily_post_limit = EXCLUDED.daily_post_limit;
        
        v_membership_type := 'free';
        v_daily_limit := 3;
    END IF;
    
    -- ä»Šæ—¥ã®æŠ•ç¨¿æ•°ã‚’å–å¾—
    SELECT COALESCE(dpc.post_count, 0), COALESCE(dpc.limit_removed_count, 0)
    INTO v_current_count, v_limit_removed_count
    FROM daily_post_counts dpc
    WHERE dpc.user_id = p_user_id AND dpc.post_date = p_post_date;
    
    -- æŠ•ç¨¿æ•°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯0ã¨ã™ã‚‹
    IF v_current_count IS NULL THEN
        v_current_count := 0;
        v_limit_removed_count := 0;
    END IF;
    
    -- åˆ¶é™è§£é™¤å›æ•°åˆ†ã‚’è¿½åŠ 
    v_daily_limit := v_daily_limit + v_limit_removed_count;
    
    -- çµæœã‚’è¿”ã™
    RETURN QUERY SELECT
        v_current_count < v_daily_limit AS can_post,
        v_current_count,
        v_daily_limit,
        GREATEST(0, v_daily_limit - v_current_count) AS remaining_posts,
        v_membership_type;
END;
$$ LANGUAGE plpgsql;

-- 5. remove_post_limit_with_pointsé–¢æ•°ã‚‚SECURITY DEFINERã§å†ä½œæˆ
CREATE OR REPLACE FUNCTION remove_post_limit_with_points(p_user_id TEXT, p_points_cost INTEGER DEFAULT 30)
RETURNS TABLE (
    success BOOLEAN,
    message TEXT,
    new_post_count INTEGER,
    new_limit INTEGER
)
SECURITY DEFINER
AS $$
DECLARE
    v_current_points INTEGER;
    v_current_date DATE := CURRENT_DATE;
    v_current_count INTEGER;
    v_limit_removed_count INTEGER;
    v_daily_limit INTEGER;
    v_current_user_id TEXT;
BEGIN
    -- ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    v_current_user_id := auth.uid()::text;
    
    -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼šå‘¼ã³å‡ºã—å…ƒãŒå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜ã‹ç¢ºèª
    IF v_current_user_id IS NULL OR v_current_user_id != p_user_id THEN
        RAISE EXCEPTION 'Unauthorized access: user can only remove their own post limit';
    END IF;
    
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
    SELECT COALESCE(total_points, 0) INTO v_current_points
    FROM user_points
    WHERE user_id = p_user_id::UUID;
    
    -- ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ
    IF v_current_points < p_points_cost THEN
        RETURN QUERY SELECT FALSE, 'ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™', 0, 0;
        RETURN;
    END IF;
    
    -- ä»Šæ—¥ã®æŠ•ç¨¿æ•°ã¨åˆ¶é™è§£é™¤å›æ•°ã‚’å–å¾—
    SELECT COALESCE(dpc.post_count, 0), COALESCE(dpc.limit_removed_count, 0)
    INTO v_current_count, v_limit_removed_count
    FROM daily_post_counts dpc
    WHERE dpc.user_id = p_user_id AND dpc.post_date = v_current_date;
    
    -- åŸºæœ¬åˆ¶é™ã‚’å–å¾—
    SELECT daily_post_limit INTO v_daily_limit
    FROM user_memberships
    WHERE user_id = p_user_id;
    
    -- åˆ¶é™è§£é™¤å›æ•°ãŒä¸Šé™ï¼ˆ5å›ï¼‰ã«é”ã—ã¦ã„ã‚‹å ´åˆ
    IF v_limit_removed_count >= 5 THEN
        RETURN QUERY SELECT FALSE, '1æ—¥ã®åˆ¶é™è§£é™¤å›æ•°ã®ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™', v_current_count, v_daily_limit + v_limit_removed_count;
        RETURN;
    END IF;
    
    -- ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»
    UPDATE user_points
    SET total_points = total_points - p_points_cost,
        updated_at = NOW()
    WHERE user_id = p_user_id::UUID;
    
    -- åˆ¶é™è§£é™¤å›æ•°ã‚’å¢—åŠ 
    INSERT INTO daily_post_counts (user_id, post_date, post_count, limit_removed_count)
    VALUES (p_user_id, v_current_date, COALESCE(v_current_count, 0), v_limit_removed_count + 1)
    ON CONFLICT (user_id, post_date)
    DO UPDATE SET 
        limit_removed_count = daily_post_counts.limit_removed_count + 1,
        updated_at = NOW();
    
    -- åˆ¶é™è§£é™¤å±¥æ­´ã‚’è¨˜éŒ²
    INSERT INTO post_limit_removals (user_id, removal_date, points_cost, post_limit_increased_by)
    VALUES (p_user_id, v_current_date, p_points_cost, 1);
    
    -- ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã‚’è¨˜éŒ²
    INSERT INTO point_transactions (user_id, points, transaction_type, created_at)
    VALUES (p_user_id::UUID, -p_points_cost, 'daily_limit_remove', NOW());
    
    RETURN QUERY SELECT TRUE, 'åˆ¶é™è§£é™¤ãŒå®Œäº†ã—ã¾ã—ãŸ', v_current_count, v_daily_limit + v_limit_removed_count + 1;
END;
$$ LANGUAGE plpgsql;

-- âœ… ä¿®æ­£å®Œäº†
-- ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œå¾Œã€æŠ•ç¨¿åˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã•ã‚Œã¾ã™