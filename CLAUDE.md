# 議論投票プラットフォーム - 開発状況

## 解決済み課題

### ✅ Issue #24: ユーザーのポイントを表示（解決済み）

- **解決日**: 2025-06-26
- **実装内容**:
  - Navbarの通知アイコン横にユーザーポイント表示機能
  - ユーザーポイントシステムの完全実装（`user_points`, `point_transactions`テーブル）
  - ポイント付与の自動化（投票：1.0pt、コメント：0.5pt、自動拡散：10.0pt）
  - 各投稿につき1回のみのポイント付与制限機能
  - 小数点対応（DECIMAL型）によるポイント表示（例：1.5ポイント）
  - ポイント履歴管理とトランザクション追跡
  - データベーストリガーによる自動ポイント計算
  - フロントエンド用カスタムフック (`useUserPoints.ts`)

### ✅ Issue #19: サイドメニュー人気の投票ページの作成（解決済み）

- **解決日**: 2025-06-24
- **実装内容**:
  - スペース関係なく全投稿の人気ランキング表示システム
  - リアルタイム人気投票ページ (`/trending`) - アクティブな投票のみ表示
  - 投票結果ページ (`/results`) - 期限終了投票の人気ランキング表示
  - 人気度スコア算出アルゴリズム: `投票数 + コメント数 × 0.5 + 新規度ボーナス`
  - 共有可能なRankingListコンポーネント (`src/components/Vote/RankingList.tsx`)
  - データベース関数: `get_popular_posts_active_with_communities`, `get_popular_posts_completed_with_communities`
  - レスポンシブデザインとモダンなサイドパネル付きUI

### ✅ Issue #18: 派生質問作成時に該当者に通知する（解決済み）

- **解決日**: 2025-06-23
- **実装内容**:
  - 派生質問作成時に対象投票者への自動通知機能
  - 通知ユーティリティ関数 (`src/utils/notifications.ts`)
  - CreateNestedPost.tsxへの通知機能統合
  - 説得タイム開始・終了時の自動通知機能
  - 投票期限終了時の通知機能

### ✅ 説得タイム中の1度限りの投票変更機能（解決済み）

- **解決日**: 2025-06-23
- **実装内容**:
  - 説得タイム中の投票変更を1度に制限
  - 投票変更確認モーダル (`VoteConfirmModal.tsx`)
  - データベーススキーマ拡張 (説得タイム追跡フィールド追加)
  - 投票ロジックの強化 (`useHandleVotes.ts`)

### ✅ Issue #17: ネスト表示の改善（解決済み）

- **解決日**: 2025-06-22
- **内容**: ネスト投稿の表示とUIの改善完了

### ✅ 通知機能の実装（解決済み）

- **解決日**: 2025-06-23
- **コミット**: 192acf1 通知機能の実装, 9219289 通知マークの設定
- **内容**: リアルタイム通知システムの実装とUI改善

### ✅ Issue #15: 派生質問の表示（解決済み）

- **解決日**: 2025-06-21
- **コミット**: 025d52b 派生質問表示UI修正

### ✅ Issue #14: 派生質問のフォーム入力時のバグ対応（解決済み）

- **問題**: React Hook Form の複数フィールドで同じ name 属性を使用することによる状態競合とフォーカスロスト
- **解決策**: 各フィールドに固有の名前 (`pro_opinion`, `con_opinion`, `detailed_description`) を設定し、個別の register() 関数で管理
- **修正ファイル**: `src/components/Post/CreateNestedPost.tsx`, `src/utils/schema.tsx`
- **解決日**: 2025-06-21

### ✅ Issue #12: 派生質問の回答者の絞り込み（解決済み）

- **解決日**: 2025-06-19

### ✅ Issue #11: ユーザーのプロフィールページの作成（解決済み）

- **解決日**: 2025-06-18

### ✅ Issue #10: ランキングのタイトル名にリンク付与（解決済み）

- **解決日**: 2025-06-16

### ✅ Issue #9: 各スペースに人気のある投稿を表示（解決済み）

- **解決日**: 2025-06-17

### ✅ Issue #8: 投稿時の入力形式の実装（解決済み）

- **解決日**: 2025-06-17

### ✅ Issue #7: スペース一覧画面に投稿数表示（解決済み）

- **解決日**: 2025-06-17

### ✅ Issue #5: タグの追加（解決済み）

- **解決日**: 2025-06-17

### ✅ Issue #4: スペース作成フォームの変更（解決済み）

- **解決日**: 2025-06-15

### ✅ Issue #3: サイドバーにサブメニュー実装（解決済み）

- **解決日**: 2025-06-17

### ✅ Issue #1: 説得タイム中の再投票機能（解決済み）

- **解決日**: 2025-06-14

## 現在の開発状況

### 🚀 最新の実装済み機能

1. **ユーザーポイントシステム** - Navbar表示、自動付与、小数点対応の完全実装
2. **人気投票ランキングシステム** - 全スペース横断の人気投票表示とランキング機能
3. **説得タイム投票システム** - 期限前1時間の1度限りの投票変更機能
4. **派生質問通知機能** - 対象投票者への自動通知システム
5. **リアルタイム通知機能** - 通知システムとマーク表示機能
6. **派生質問機能** - ユーザーが投稿から派生した質問を作成可能
7. **ネスト投稿システム** - 最大3段階の階層構造をサポート
8. **ユーザープロフィールページ** - 個人情報とアクティビティ表示
9. **お気に入りブックマーク機能** - 投稿のブックマーク保存と管理
10. **Docker対応** - 開発環境とVite設定の最適化完了
11. **MCP (Model Context Protocol) 設定** - Supabase接続とContext7設定

### 📁 プロジェクト構造

- **Frontend**: React 19 + TypeScript + Vite
- **Styling**: Tailwind CSS + shadcn/ui
- **Backend**: Supabase (PostgreSQL + Auth + Realtime)
- **Container**: Docker + docker-compose
- **State Management**: Jotai (Atom-based)

### 🔧 技術的な改善点

- フォーム管理の最適化（React Hook Form）
- コンポーネントの再レンダリング最適化
- 時間表示フォーマットの統一
- 共通化されたUI関数とコンポーネント
- 開発環境のDocker最適化（Dockerfile.dev追加）
- Viteビルド設定の改善（HMR対応）
- データベーススキーマ拡張（説得タイム追跡）
- 投票システムの楽観的更新とエラーハンドリング強化
- 人気投票ランキング用データベース関数の実装
- 共有可能なRankingListコンポーネントの設計
- TypeScript型定義の統一（BasePost, PopularPost, CompletedPost）

## 現在のオープンなIssue

### 🔄 進行中・未解決の課題

#### 高優先度（新規・最近作成）

- **Issue #23**: コミュニティページのUI修正（2025-06-25作成）
- **Issue #22**: 派生質問のボタン位置検討（2025-06-24作成）
- **Issue #20**: 設定画面の実装（2025-06-24作成）

#### 継続課題

- **Issue #16**: （保留）一番参考にされているコメントについて（2025-06-21作成）
- **Issue #6**: AIの導入（2025-06-22更新）
- **Issue #2**: コメントに対して「共感ポイント」「説得力スコア」機能実装（2025-06-18作成）

### 📝 最近解決された課題

- **Issue #24**: ユーザーポイント表示システム - Navbar表示、自動付与、小数点対応完成
- **Issue #21**: お気に入りブックマーク機能 - 投稿のブックマーク保存と管理機能完成
- **Issue #19**: 人気投票ランキングページ - 全スペース横断の人気投票システム完成
- **Issue #18**: 通知機能の完全実装 - 説得タイム・期限終了・派生質問通知

## 次のマイルストーン

### 🎯 優先実装項目

- 設定画面の実装（Issue #20）
- コミュニティページUI修正（Issue #23）
- 派生質問UI改善（Issue #22）
- コメント表示バグの修正（ネストコメント階層表示）

### 📋 継続開発項目

- 共感ポイント・説得力スコア機能（Issue #2）
- AIの導入検討（Issue #6）
- 参考コメント機能（Issue #16）
- 説得タイム統計・分析機能の追加
- 通知機能の拡張とパフォーマンス最適化

## 最新の変更履歴

### 2025-06-26

- **Issue #24 ユーザーポイントシステム実装完了**:
  - ユーザーポイントテーブルとトランザクション履歴テーブル作成
  - 自動ポイント付与システム（投票1.0pt、コメント0.5pt、自動拡散10.0pt）
  - 各投稿につき1回のみポイント付与制限
  - 小数点対応ポイント表示（DECIMAL型使用）
  - Navbarへのポイント表示統合
  - データベーストリガーとカスタムフック実装
- **コメント表示バグ修正**:
  - ネストコメント階層表示の修正
  - `CommentItem.tsx`の子コメント表示ロジック改善
  - `children: []`による意図しない階層制限の解除
- **データベースマイグレーション**:
  - `migration_add_user_points_final.sql`実装
  - int8型ID、DECIMAL型ポイント、自動トリガー設定

### 2025-06-25

- **GitHub Issues管理**:
  - Issue #24「ユーザーのポイントを表示」作成
  - Issue #23「コミュニティページのUI修正」作成
- **CLAUDE.md文書更新** - GitHub Issuesとの同期完了

### 2025-06-24

- **GitHub Issues管理**:

  - Issue #22「派生質問のボタン位置検討」作成
  - Issue #21「お気に入りブックマーク機能の設定」作成
  - Issue #20「設定画面の実装」作成

- **人気投票ランキングシステム実装完了** - 全スペース横断の人気投票表示機能
- **PopularVotesPage作成** - リアルタイム人気投票ページ (`/trending`)
- **VoteResultsPage作成** - 期限終了投票の結果ランキングページ (`/results`)
- **RankingListコンポーネント共有化** - 両ページで再利用可能な共通コンポーネント
- **データベース関数実装** - `get_popular_posts_active_with_communities`, `get_popular_posts_completed_with_communities`
- **人気度スコア算出アルゴリズム** - 投票数・コメント数・新規度を考慮した総合スコア
- **TypeScript型定義統一** - BasePost, PopularPost, CompletedPostの型システム
- **レスポンシブUI実装** - モダンなサイドパネル付きデザイン

### 2025-06-23

- **説得タイム投票制限機能実装完了** - 1度限りの投票変更機能と確認モーダル
- **派生質問通知機能実装完了** - 対象投票者への自動通知機能
- **データベーススキーマ拡張** - 説得タイム追跡フィールド追加
- **投票システム強化** - エラーハンドリングと楽観的更新の改善
- **通知機能実装完了** - リアルタイム通知とUI表示機能
- **開発環境最適化** - Docker開発環境とVite設定の改善
- **コンポーネントリファクタリング** - 共通コンポーネントの整理

### 実装済みの主要コンポーネント

#### 人気投票ランキング関連

- `PopularVotesPage.tsx` - リアルタイム人気投票ページ
- `VoteResultsPage.tsx` - 期限終了投票結果ページ
- `RankingList.tsx` - 共有ランキング表示コンポーネント
- `types/post.ts` - BasePost, PopularPost, CompletedPost型定義

#### 説得タイム関連

- `VoteConfirmModal.tsx` - 投票変更確認モーダル
- `PersuasionStatsDisplay.tsx` - 説得タイム統計表示
- `useHandleVotes.ts` - 説得タイム対応投票フック

#### 通知関連

- `notifications.ts` - 通知ユーティリティ関数
- `NotificationDropdown.tsx` - 通知ドロップダウン
- `useNotifications.ts` - 通知管理フック

#### ユーザーポイント関連

- `useUserPoints.ts` - ユーザーポイント管理カスタムフック
- `migration_add_user_points_final.sql` - ポイントシステムマイグレーション
- Navbarポイント表示コンポーネント統合

#### データベース関連

- `migration_add_popular_posts_function.sql` - 人気投票ランキング関数
- `migration_add_persuasion_tracking.sql` - 説得タイム追跡マイグレーション
- `migration_add_user_points_final.sql` - ユーザーポイントシステム完全実装
